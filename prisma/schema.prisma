generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  telegramId            String                  @unique
  username              String?
  firstName             String?
  lastSeenAt            DateTime                @default(now())
  id                    Int                     @id @default(autoincrement())
  createdAt             DateTime                @default(now())
  epicBoostLevel        Int                     @default(0)
  extraTimeLevel        Int                     @default(0)
  multiplierLevel       Int                     @default(0)
  stars                 Int                     @default(0)
  dailyCatch1000ClaimAt DateTime?
  dailyEpic100ClaimAt   DateTime?
  dailyPlay3ClaimAt     DateTime?
  level                 Int                     @default(1)
  xp                    Int                     @default(0)
  coins                 Int                     @default(0)
  games                 Game[]
  referralsReceived     Referral[]              @relation("UserInvited")
  referralsSent         Referral[]              @relation("UserInviter")
  tournaments           TournamentParticipant[]
  Payment               Payment[]
  Withdrawal            Withdrawal[]
}

model Game {
  id         Int       @id @default(autoincrement())
  userId     Int
  score      Int?
  createdAt  DateTime  @default(now())
  finishedAt DateTime?
  clicks     Int?      @default(0)
  epicCount  Int?      @default(0)
  user       User      @relation(fields: [userId], references: [id])
}

model Referral {
  id        Int      @id @default(autoincrement())
  inviterId Int
  invitedId Int
  rewarded  Boolean  @default(false)
  createdAt DateTime @default(now())
  invited   User     @relation("UserInvited", fields: [invitedId], references: [id])
  inviter   User     @relation("UserInviter", fields: [inviterId], references: [id])

  @@unique([inviterId, invitedId])
}

model Tournament {
  id           Int                     @id @default(autoincrement())
  startsAt     DateTime
  endsAt       DateTime
  joinDeadline DateTime
  entryFee     Int
  prizePool    Int                     @default(0)
  status       TournamentStatus        @default(PLANNED)
  createdAt    DateTime                @default(now())
  participants TournamentParticipant[]
}

model TournamentParticipant {
  id           Int        @id @default(autoincrement())
  userId       Int
  tournamentId Int
  score        Int        @default(0)
  createdAt    DateTime   @default(now())
  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  @@unique([userId, tournamentId])
}

model Payment {
  id                      Int      @id @default(autoincrement())
  telegramPaymentChargeId String   @unique
  providerPaymentChargeId String? // для Stars обычно null
  starsAmount             Int
  coinsAmount             Int
  payload                 String?
  user                    User     @relation(fields: [userId], references: [id])
  userId                  Int
  createdAt               DateTime @default(now())
}

model Withdrawal {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  coins     Int // сколько coins списали за этот вывод
  amountUsd Float // во сколько USD это оценили (по твоему курсу)
  amountTon Float? // сколько TON отправишь (если вывод в TON)
  currency  String @default("TON") // TON/USDT и т.д.

  network String // TON / TRC20 / BEP20 / ERC20 и т.п.
  address String // адрес кошелька пользователя

  status WithdrawalStatus @default(PENDING)
  txHash String?

  createdAt   DateTime  @default(now())
  processedAt DateTime?
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum TournamentStatus {
  PLANNED
  ACTIVE
  FINISHED
}
