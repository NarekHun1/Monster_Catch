generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  telegramId            String    @unique
  username              String?
  firstName             String?
  lastSeenAt            DateTime  @default(now())
  id                    Int       @id @default(autoincrement())
  createdAt             DateTime  @default(now())
  epicBoostLevel        Int       @default(0)
  extraTimeLevel        Int       @default(0)
  multiplierLevel       Int       @default(0)
  stars                 Int       @default(0)
  dailyCatch1000ClaimAt DateTime?
  dailyEpic100ClaimAt   DateTime?
  dailyPlay3ClaimAt     DateTime?
  level                 Int       @default(1)
  xp                    Int       @default(0)
  coins                 Int       @default(0)
  tonAddress            String?
  usdtAddress           String?
  usdtNetwork           String?

  games              Game[]
  payments           Payment[]
  referralsReceived  Referral[]              @relation("UserInvited")
  referralsSent      Referral[]              @relation("UserInviter")
  tournaments        TournamentParticipant[]
  withdrawals        Withdrawal[]
  Ticket             Ticket[]
  StarExchange       StarExchange[]
  isBlocked          Boolean                 @default(false)
  rouletteFreeDay    String?
  rouletteLastSpinAt DateTime?
  UserQuest          UserQuest[]
  UserMonster        UserMonster[]
  FarmSlot           FarmSlot[]
  meat               Int                     @default(0)
  MonsterHunt        MonsterHunt[]
  isBot              Boolean                 @default(false)
  // ✅ Market
  marketUnlocked     Boolean                 @default(false)
  marketSales        MarketListing[]         @relation("MarketSeller")
  marketPurchases    MarketListing[]         @relation("MarketBuyer")
}

model Game {
  id         Int       @id @default(autoincrement())
  userId     Int
  score      Int?
  createdAt  DateTime  @default(now())
  finishedAt DateTime?
  clicks     Int?      @default(0)
  epicCount  Int?      @default(0)
  melasCount Int?      @default(0)

  user User @relation(fields: [userId], references: [id])
}

model Referral {
  id        Int      @id @default(autoincrement())
  inviterId Int
  invitedId Int
  rewarded  Boolean  @default(false)
  createdAt DateTime @default(now())
  invited   User     @relation("UserInvited", fields: [invitedId], references: [id])
  inviter   User     @relation("UserInviter", fields: [inviterId], references: [id])

  @@unique([inviterId, invitedId])
}

model Tournament {
  id   Int            @id @default(autoincrement())
  type TournamentType @default(HOURLY)

  slug      String? @unique
  rulesJson Json?

  startsAt     DateTime
  endsAt       DateTime
  joinDeadline DateTime
  entryFee     Int
  prizePool    Int                     @default(0)
  status       TournamentStatus        @default(PLANNED)
  createdAt    DateTime                @default(now())
  participants TournamentParticipant[]
}

model TournamentParticipant {
  id           Int      @id @default(autoincrement())
  userId       Int
  tournamentId Int
  score        Int      @default(0)
  createdAt    DateTime @default(now())
  payWith      String   @default("coins") // "coins" | "tickets"

  tournament Tournament @relation(fields: [tournamentId], references: [id])
  user       User       @relation(fields: [userId], references: [id])

  @@unique([userId, tournamentId])
}

model Payment {
  id                      Int      @id @default(autoincrement())
  telegramPaymentChargeId String   @unique
  providerPaymentChargeId String?
  starsAmount             Int
  coinsAmount             Int
  payload                 String?
  userId                  Int
  createdAt               DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Withdrawal {
  id          Int              @id @default(autoincrement())
  userId      Int
  coins       Int
  amountUsd   Float
  amountTon   Float?
  currency    String           @default("TON")
  network     String
  address     String
  status      WithdrawalStatus @default(PENDING)
  txHash      String?
  createdAt   DateTime         @default(now())
  processedAt DateTime?

  user User @relation(fields: [userId], references: [id])
}

model Quest {
  id            Int       @id @default(autoincrement())
  title         String
  description   String?
  type          QuestType @default(SUBSCRIBE)
  rewardTickets Int       @default(1)

  chatId       String?
  chatUsername String?
  inviteLink   String?
  openUrl      String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  completions UserQuest[]
}

model UserQuest {
  id          Int             @id @default(autoincrement())
  userId      Int
  questId     Int
  status      UserQuestStatus @default(PENDING)
  completedAt DateTime?
  claimedAt   DateTime?
  createdAt   DateTime        @default(now())
  openedAt    DateTime?

  user  User  @relation(fields: [userId], references: [id])
  quest Quest @relation(fields: [questId], references: [id])

  @@unique([userId, questId])
  @@index([userId, status])
}

model StarExchange {
  id        Int      @id @default(autoincrement())
  userId    Int
  stars     Int
  ticketId  Int
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  ticket Ticket @relation(fields: [ticketId], references: [id])
}

model Ticket {
  id        Int        @id @default(autoincrement())
  userId    Int
  type      TicketType
  createdAt DateTime   @default(now())
  usedAt    DateTime?

  user         User           @relation(fields: [userId], references: [id])
  StarExchange StarExchange[]

  @@index([userId, type])
}

model MonsterDef {
  id        Int           @id @default(autoincrement())
  key       String        @unique
  name      String
  rarity    MonsterRarity
  imgUrl    String
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())

  users          UserMonster[]
  marketListings MarketListing[]
}

model UserMonster {
  id        Int @id @default(autoincrement())
  userId    Int
  monsterId Int
  count     Int @default(0)

  level Int @default(1) // 1..5
  xp    Int @default(0)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  feedCountForHunt Int          @default(0) // 0..100
  hunt             MonsterHunt?

  user    User       @relation(fields: [userId], references: [id])
  monster MonsterDef @relation(fields: [monsterId], references: [id])
  slots   FarmSlot[]

  // ✅ один активный лот максимум (и вообще связь "лот для этого монстра")
  marketListing MarketListing?

  @@unique([userId, monsterId])
  @@index([userId])
}

model FarmSlot {
  id            Int       @id @default(autoincrement())
  userId        Int
  slotIndex     Int
  isUnlocked    Boolean   @default(false)
  unlockPrice   Int       @default(0)
  userMonsterId Int?
  fedCountToday Int       @default(0)
  lastFedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user        User         @relation(fields: [userId], references: [id])
  userMonster UserMonster? @relation(fields: [userMonsterId], references: [id])

  @@unique([userId, slotIndex])
  @@index([userId])
}

model MonsterHunt {
  id            Int @id @default(autoincrement())
  userId        Int
  userMonsterId Int @unique

  status    HuntStatus @default(RUNNING)
  startedAt DateTime   @default(now())
  endsAt    DateTime

  rewardStars   Int @default(0)
  rewardTickets Int @default(0)
  rewardCoins   Int @default(0)
  rewardMeat    Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User        @relation(fields: [userId], references: [id])
  userMonster UserMonster @relation(fields: [userMonsterId], references: [id])

  @@index([userId])
}

model MarketListing {
  id Int @id @default(autoincrement())

  sellerId Int
  buyerId  Int?

  userMonsterId Int
  monsterId     Int

  price    Int
  currency MarketCurrency
  status   MarketStatus   @default(ACTIVE)

  fromSlotIndex Int?
  createdAt     DateTime  @default(now())
  soldAt        DateTime?

  seller      User        @relation("MarketSeller", fields: [sellerId], references: [id])
  buyer       User?       @relation("MarketBuyer", fields: [buyerId], references: [id])
  userMonster UserMonster @relation(fields: [userMonsterId], references: [id])
  monster     MonsterDef  @relation(fields: [monsterId], references: [id])

  @@unique([userMonsterId]) // 1 лот на 1 UserMonster
  @@index([status, createdAt])
  @@index([sellerId, status])
}

enum QuestType {
  SUBSCRIBE
  INSTAGRAM_FOLLOW
}

enum UserQuestStatus {
  PENDING
  COMPLETED
  CLAIMED
}

enum HuntStatus {
  RUNNING
  CLAIMED
}

enum MonsterRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum TicketType {
  TOURNAMENT
  REFERRAL
  ROULETTE
  QUEST
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum TournamentStatus {
  PLANNED
  ACTIVE
  FINISHED
}

enum PayWith {
  coins
  tickets
}

enum TournamentType {
  HOURLY
  DAILY
  CASH_CUP
}

enum MarketStatus {
  ACTIVE
  SOLD
  CANCELED
}

enum MarketCurrency {
  COINS
  STARS
}
